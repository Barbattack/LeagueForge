{% extends 'admin/base.html' %}

{% block title %}Import in corso - LeagueForge{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-upload"></i> Import in Corso
                </h4>
            </div>

            <div class="card-body">
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span id="progress-label" class="fw-bold">Inizializzazione...</span>
                        <span id="progress-percent" class="text-muted">0%</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%"
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                </div>

                <!-- Log Console -->
                <div class="card bg-dark text-light">
                    <div class="card-header">
                        <small><i class="fas fa-terminal"></i> Log Import</small>
                    </div>
                    <div class="card-body p-2" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                        <div id="log-container"></div>
                    </div>
                </div>

                <!-- Spinner (nascosto al completamento) -->
                <div id="spinner-container" class="text-center mt-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Import in corso...</span>
                    </div>
                    <p class="text-muted mt-2">Attendere prego...</p>
                </div>

                <!-- Buttons (nascosti fino al completamento) -->
                <div id="result-buttons" class="d-none mt-4">
                    <div id="success-message" class="alert alert-success d-none">
                        <i class="fas fa-check-circle"></i> <strong>Import completato con successo!</strong>
                    </div>
                    <div id="error-message" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-triangle"></i> <strong>Errore durante import.</strong>
                        <p id="error-text" class="mb-0 mt-2"></p>
                    </div>

                    <div class="d-flex gap-2">
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-primary">
                            <i class="fas fa-home"></i> Torna al Dashboard
                        </a>
                        <a href="{{ url_for('admin.import_wizard') }}" class="btn btn-secondary">
                            <i class="fas fa-plus"></i> Nuovo Import
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tracker ID passato dal template
const trackerId = "{{ tracker_id }}";

// Elementi DOM
const progressBar = document.getElementById('progress-bar');
const progressPercent = document.getElementById('progress-percent');
const progressLabel = document.getElementById('progress-label');
const logContainer = document.getElementById('log-container');
const spinnerContainer = document.getElementById('spinner-container');
const resultButtons = document.getElementById('result-buttons');
const successMessage = document.getElementById('success-message');
const errorMessage = document.getElementById('error-message');
const errorText = document.getElementById('error-text');

// Connect to SSE stream
const eventSource = new EventSource(`{{ url_for('admin.import_progress_stream', tracker_id='TRACKER_ID') }}`.replace('TRACKER_ID', trackerId));

// Level colors for log
const levelColors = {
    'info': 'text-info',
    'success': 'text-success',
    'warning': 'text-warning',
    'error': 'text-danger'
};

// Handle incoming messages
eventSource.onmessage = function(event) {
    const data = JSON.parse(event.data);

    if (data.error) {
        addLogEntry(`❌ ${data.error}`, 'error');
        showError(data.error);
        eventSource.close();
        return;
    }

    // Handle different message types
    switch(data.type) {
        case 'progress':
            updateProgress(data.percentage, data.message);
            if (data.message) {
                // Progress updates don't get logged separately (already shown in bar)
            }
            break;

        case 'log':
            addLogEntry(data.message, data.level);
            break;

        case 'complete':
            if (data.success) {
                updateProgress(100, data.message);
                addLogEntry(data.message || 'Completato!', 'success');
                showSuccess();
            } else {
                addLogEntry(data.message || 'Errore', 'error');
                showError(data.message);
            }
            eventSource.close();
            cleanup();
            break;

        case 'done':
            // Stream chiuso
            eventSource.close();
            break;
    }
};

eventSource.onerror = function(err) {
    console.error('EventSource error:', err);
    addLogEntry('❌ Connessione persa con il server', 'error');
    showError('Connessione persa. Ricaricare la pagina.');
    eventSource.close();
};

function updateProgress(percentage, message) {
    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', percentage);
    progressPercent.textContent = percentage + '%';

    if (message) {
        progressLabel.textContent = message;
    }

    if (percentage >= 100) {
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
    }
}

function addLogEntry(message, level = 'info') {
    const logLine = document.createElement('div');
    logLine.className = levelColors[level] || 'text-light';
    logLine.textContent = message;
    logContainer.appendChild(logLine);

    // Auto-scroll to bottom
    logContainer.parentElement.scrollTop = logContainer.parentElement.scrollHeight;
}

function showSuccess() {
    spinnerContainer.classList.add('d-none');
    resultButtons.classList.remove('d-none');
    successMessage.classList.remove('d-none');
}

function showError(message) {
    spinnerContainer.classList.add('d-none');
    resultButtons.classList.remove('d-none');
    errorMessage.classList.remove('d-none');
    errorText.textContent = message || 'Errore sconosciuto';
}

function cleanup() {
    // Chiama endpoint di cleanup
    fetch("{{ url_for('admin.import_wizard_complete') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    }).catch(err => console.error('Cleanup error:', err));
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (eventSource) {
        eventSource.close();
    }
    cleanup();
});
</script>

<style>
#log-container > div {
    padding: 2px 5px;
    border-left: 3px solid transparent;
}

#log-container > div.text-success {
    border-left-color: #28a745;
}

#log-container > div.text-danger {
    border-left-color: #dc3545;
}

#log-container > div.text-warning {
    border-left-color: #ffc107;
}

#log-container > div.text-info {
    border-left-color: #17a2b8;
}
</style>
{% endblock %}
