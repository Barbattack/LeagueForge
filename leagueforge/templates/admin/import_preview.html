{% extends "base.html" %}

{% block title %}Preview Import - Admin Panel{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="fas fa-eye"></i> Preview Dati Import</h1>
        <p class="text-muted">Verifica i dati prima di confermare l'import</p>
    </div>
</div>

<!-- Progress Steps -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="step-indicator completed">
                <div class="step-number">✓</div>
                <div class="step-label">Selezione</div>
            </div>
            <div class="step-line completed-line"></div>
            <div class="step-indicator completed">
                <div class="step-number">✓</div>
                <div class="step-label">Upload File</div>
            </div>
            <div class="step-line completed-line"></div>
            <div class="step-indicator active">
                <div class="step-number">3</div>
                <div class="step-label">Preview</div>
            </div>
            <div class="step-line"></div>
            <div class="step-indicator">
                <div class="step-number">4</div>
                <div class="step-label">Conferma</div>
            </div>
        </div>
    </div>
</div>

<!-- Warnings/Alerts -->
{% if duplicate_warning %}
<div class="alert alert-danger">
    <h5><i class="fas fa-exclamation-triangle"></i> Torneo Duplicato Rilevato!</h5>
    <p>{{ duplicate_warning }}</p>
    <p class="mb-0">
        <strong>Opzioni:</strong>
        <button class="btn btn-sm btn-danger" onclick="document.getElementById('overwrite-mode').value='true'; confirmImport();">
            <i class="fas fa-exclamation-circle"></i> Sovrascrivi
        </button>
        <a href="{{ url_for('admin.import_wizard_cancel') }}" class="btn btn-sm btn-secondary">
            <i class="fas fa-times"></i> Annulla
        </a>
    </p>
</div>
{% endif %}

<!-- Tournament Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <h3 class="text-primary">{{ stats.n_participants }}</h3>
                <p class="mb-0">Partecipanti</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <h3 class="text-success">{{ stats.n_rounds or 'N/A' }}</h3>
                <p class="mb-0">Round</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h6 class="text-warning mb-1">Vincitore</h6>
                <p class="mb-0"><strong>{{ stats.winner }}</strong></p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <h6 class="text-info mb-1">Data</h6>
                <p class="mb-0">{{ stats.date }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Tournament Info -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informazioni Torneo</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <strong>TCG:</strong> {{ tcg.upper() }}
            </div>
            <div class="col-md-4">
                <strong>Stagione:</strong> {{ season_id }}
            </div>
            <div class="col-md-4">
                <strong>Tournament ID:</strong> <code>{{ stats.tournament_id }}</code>
            </div>
        </div>
        {% if test_mode %}
        <div class="alert alert-warning mt-3 mb-0">
            <i class="fas fa-flask"></i> <strong>TEST MODE ATTIVO</strong> - Nessun dato sarà scritto
        </div>
        {% endif %}
    </div>
</div>

<!-- Participants Table -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-users"></i> Classifica Finale</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Rank</th>
                        <th>Nome</th>
                        <th>Membership</th>
                        <th>W-T-L</th>
                        <th>Win Points</th>
                        <th>OMW%</th>
                        <th>Punti LeagueForge</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in participants %}
                    <tr {% if loop.index == 1 %}class="table-warning"{% endif %}>
                        <td>
                            {% if loop.index == 1 %}
                                <i class="fas fa-trophy text-warning"></i>
                            {% elif loop.index <= 3 %}
                                <i class="fas fa-medal text-secondary"></i>
                            {% endif %}
                            {{ p.rank }}
                        </td>
                        <td><strong>{{ p.name }}</strong></td>
                        <td><code>{{ p.membership }}</code></td>
                        <td>{{ p.wins }}-{{ p.ties }}-{{ p.losses }}</td>
                        <td>{{ p.win_points }}</td>
                        <td>{{ "%.1f"|format(p.omw|default(0)) }}%</td>
                        <td><span class="badge bg-success">{{ p.points_total|default(0) }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="card mb-4">
    <div class="card-body text-center">
        <form method="POST" action="{{ url_for('admin.import_wizard_confirm') }}" id="form-confirm">
            <input type="hidden" name="overwrite" id="overwrite-mode" value="false">

            {% if not duplicate_warning %}
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-check-circle"></i> Conferma Import
            </button>
            {% endif %}

            <a href="{{ url_for('admin.import_wizard_cancel') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-times"></i> Annulla
            </a>

            <button type="button" class="btn btn-info btn-lg" onclick="window.print()">
                <i class="fas fa-print"></i> Stampa Preview
            </button>
        </form>
    </div>
</div>

<style>
/* Progress Steps Styling */
.step-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 8px;
    transition: all 0.3s;
}

.step-indicator.active .step-number {
    background-color: #0d6efd;
    color: white;
}

.step-indicator.completed .step-number {
    background-color: #198754;
    color: white;
}

.step-label {
    font-size: 0.85rem;
    color: #6c757d;
}

.step-indicator.active .step-label {
    color: #0d6efd;
    font-weight: bold;
}

.step-indicator.completed .step-label {
    color: #198754;
}

.step-line {
    flex: 1;
    height: 2px;
    background-color: #e9ecef;
    margin: 0 10px;
    align-self: center;
    margin-bottom: 30px;
}

.step-line.completed-line {
    background-color: #198754;
}

/* Print Styles */
@media print {
    .btn, .navbar, .step-indicator, .step-line {
        display: none !important;
    }
}
</style>

<script>
function confirmImport() {
    const form = document.getElementById('form-confirm');
    const btn = form.querySelector('button[type="submit"]');

    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importazione in corso...';
    }

    form.submit();
}

// Auto-submit if overwrite mode
{% if duplicate_warning and request.args.get('auto_overwrite') %}
    document.getElementById('overwrite-mode').value = 'true';
    setTimeout(confirmImport, 1000);
{% endif %}
</script>

{% endblock %}
